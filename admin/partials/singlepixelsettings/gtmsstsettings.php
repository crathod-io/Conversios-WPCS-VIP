<?php
$gcp_regions = array(
  "asia-east1-a" => "asia-east1-a",
  "asia-east1-b" => "asia-east1-b",
  "asia-east1-c" => "asia-east1-c",
  "asia-east2-a" => "asia-east2-a",
  "asia-east2-b" => "asia-east2-b",
  "asia-east2-c" => "asia-east2-c",
  "asia-northeast1-a" => "asia-northeast1-a",
  "asia-northeast1-b" => "asia-northeast1-b",
  "asia-northeast1-c" => "asia-northeast1-c",
  "asia-northeast2-a" => "asia-northeast2-a",
  "asia-northeast2-b" => "asia-northeast2-b",
  "asia-northeast2-c" => "asia-northeast2-c",
  "asia-northeast3-a" => "asia-northeast3-a",
  "asia-northeast3-b" => "asia-northeast3-b",
  "asia-northeast3-c" => "asia-northeast3-c",
  "asia-south1-a" => "asia-south1-a",
  "asia-south1-b" => "asia-south1-b",
  "asia-south1-c" => "asia-south1-c",
  "asia-south2-a" => "asia-south2-a",
  "asia-south2-b" => "asia-south2-b",
  "asia-south2-c" => "asia-south2-c",
  "asia-southeast1-a" => "asia-southeast1-a",
  "asia-southeast1-b" => "asia-southeast1-b",
  "asia-southeast1-c" => "asia-southeast1-c",
  "asia-southeast2-a" => "asia-southeast2-a",
  "asia-southeast2-b" => "asia-southeast2-b",
  "asia-southeast2-c" => "asia-southeast2-c",
  "australia-southeast1-a" => "australia-southeast1-a",
  "australia-southeast1-b" => "australia-southeast1-b",
  "australia-southeast1-c" => "australia-southeast1-c",
  "australia-southeast2-a" => "australia-southeast2-a",
  "australia-southeast2-b" => "australia-southeast2-b",
  "australia-southeast2-c" => "australia-southeast2-c",
  "europe-north1-a" => "europe-north1-a",
  "europe-north1-b" => "europe-north1-b",
  "europe-central2-a" => "europe-central2-a",
  "europe-central2-b" => "europe-central2-b",
  "europe-central2-c" => "europe-central2-c",
  "europe-north1-c" => "europe-north1-c",
  "europe-southwest1-a" => "europe-southwest1-a",
  "europe-southwest1-b" => "europe-southwest1-b",
  "europe-southwest1-c" => "europe-southwest1-c",
  "europe-west1-b" => "europe-west1-b",
  "europe-west1-c" => "europe-west1-c",
  "europe-west1-d" => "europe-west1-d",
  "europe-west12-a" => "europe-west12-a",
  "europe-west12-b" => "europe-west12-b",
  "europe-west12-c" => "europe-west12-c",
  "europe-west2-a" => "europe-west2-a",
  "europe-west2-b" => "europe-west2-b",
  "europe-west2-c" => "europe-west2-c",
  "europe-west3-a" => "europe-west3-a",
  "europe-west3-b" => "europe-west3-b",
  "europe-west3-c" => "europe-west3-c",
  "europe-west4-a" => "europe-west4-a",
  "europe-west4-b" => "europe-west4-b",
  "europe-west4-c" => "europe-west4-c",
  "europe-west6-a" => "europe-west6-a",
  "europe-west6-b" => "europe-west6-b",
  "europe-west6-c" => "europe-west6-c",
  "europe-west8-a" => "europe-west8-a",
  "europe-west8-b" => "europe-west8-b",
  "europe-west8-c" => "europe-west8-c",
  "europe-west9-a" => "europe-west9-a",
  "europe-west9-b" => "europe-west9-b",
  "europe-west9-c" => "europe-west9-c",
  "me-central1-a" => "me-central1-a",
  "me-central1-b" => "me-central1-b",
  "me-central1-c" => "me-central1-c",
  "me-west1-a" => "me-west1-a",
  "me-west1-b" => "me-west1-b",
  "me-west1-c" => "me-west1-c",
  "northamerica-northeast1-a" => "northamerica-northeast1-a",
  "northamerica-northeast1-b" => "northamerica-northeast1-b",
  "northamerica-northeast1-c" => "northamerica-northeast1-c",
  "northamerica-northeast2-a" => "northamerica-northeast2-a",
  "northamerica-northeast2-b" => "northamerica-northeast2-b",
  "northamerica-northeast2-c" => "northamerica-northeast2-c",
  "southamerica-east1-a" => "southamerica-east1-a",
  "southamerica-east1-b" => "southamerica-east1-b",
  "southamerica-east1-c" => "southamerica-east1-c",
  "southamerica-west1-a" => "southamerica-west1-a",
  "southamerica-west1-b" => "southamerica-west1-b",
  "southamerica-west1-c" => "southamerica-west1-c",
  "us-central1-a" => "us-central1-a",
  "us-central1-b" => "us-central1-b",
  "us-central1-c" => "us-central1-c",
  "us-central1-f" => "us-central1-f",
  "us-east1-b" => "us-east1-b",
  "us-east1-c" => "us-east1-c",
  "us-east1-d" => "us-east1-d",
  "us-east4-a" => "us-east4-a",
  "us-east4-b" => "us-east4-b",
  "us-east4-c" => "us-east4-c",
  "us-east5-a" => "us-east5-a",
  "us-east5-b" => "us-east5-b",
  "us-east5-c" => "us-east5-c",
  "us-south1-a" => "us-south1-a",
  "us-south1-b" => "us-south1-b",
  "us-south1-c" => "us-south1-c",
  "us-west1-a" => "us-west1-a",
  "us-west1-b" => "us-west1-b",
  "us-west1-c" => "us-west1-c",
  "us-west2-a" => "us-west2-a",
  "us-west2-b" => "us-west2-b",
  "us-west2-c" => "us-west2-c",
  "us-west3-a" => "us-west3-a",
  "us-west3-b" => "us-west3-b",
  "us-west3-c" => "us-west3-c",
  "us-west4-a" => "us-west4-a",
  "us-west4-b" => "us-west4-b",
  "us-west4-c" => "us-west4-c",
);
?>
<div class="convcard p-4 mt-0 rounded-3 shadow-sm">
  <?php if (isset($pixel_settings_arr[$subpage]['topnoti']) && $pixel_settings_arr[$subpage]['topnoti'] != "") { ?>
    <div class="alert d-flex align-items-cente p-0" role="alert">
      <span class="p-2 material-symbols-outlined text-light conv-success-bg rounded-start">info</span>
      <div class="p-2 w-100 rounded-end border border-start-0 shadow-sm conv-notification-alert lh-lg">
        <?php esc_html_e($pixel_settings_arr[$subpage]['topnoti'], "enhanced-e-commerce-for-woocommerce-store"); ?>
      </div>
    </div>
  <?php } ?>

  <form id="gtmsstsettings_form">

    <?php
    $tracking_method = (isset($ee_options['tracking_method']) && $ee_options['tracking_method'] != "") ? $ee_options['tracking_method'] : "";
    $want_to_use_your_gtm = "";
    if ($tracking_method == "gtm") {
      $want_to_use_your_gtm = (isset($ee_options['want_to_use_your_gtm']) && $ee_options['want_to_use_your_gtm'] != "") ? $ee_options['want_to_use_your_gtm'] : "0";
    }
    $use_your_gtm_id = isset($ee_options['use_your_gtm_id']) ? $ee_options['use_your_gtm_id'] : "";

    $sst_web_container = (isset($ee_options['sst_web_container']) && $ee_options['sst_web_container'] != "") ? $ee_options['sst_web_container'] : "";
    $sst_server_container = (isset($ee_options['sst_server_container']) && $ee_options['sst_server_container'] != "") ? $ee_options['sst_server_container'] : "";
    $sst_server_container_config = (isset($ee_options['sst_server_container_config']) && $ee_options['sst_server_container_config'] != "") ? $ee_options['sst_server_container_config'] : "";
    $sst_transport_url = (isset($ee_options['sst_transport_url']) && $ee_options['sst_transport_url'] != "") ? $ee_options['sst_transport_url'] : "";
    $sst_region = (isset($ee_options['sst_region']) && $ee_options['sst_region'] != "") ? $ee_options['sst_region'] : "";

    $doc_link_url = "https://www.conversios.io/docs/how-to-create-a-web-server-side-container-and-find-the-container-config-3/?utm_source=app&utm_medium=gtmsetup&utm_campaign=doc";
    ?>

    <!-- SST Web Container -->
    <div class="mt-4">
      <h5 class="fw-normal mb-1">
        <?php esc_html_e("Google Tag Manager (Web) Container ID:", "enhanced-e-commerce-for-woocommerce-store"); ?>
      </h5>
      <input type="text" class="form-control-lg w-100" name="sst_web_container" id="sst_web_container" value="<?php echo esc_attr($sst_web_container); ?>">
      <p class="fw-bold">
        <a class="conv-link-blue" href="<?php echo esc_url_raw("https://" . TVC_AUTH_CONNECT_URL . "/help-center/configure_our_plugin_with_your_gtm.pdf"); ?>" target="_blank">
          <?php esc_html_e('How To Setup a Web Container?', "enhanced-e-commerce-for-woocommerce-store"); ?>
        </a>
      </p>
    </div>

    <!-- SST Server Container -->
    <div class="mt-4">
      <h5 class="fw-normal mb-1">
        <?php esc_html_e("Google Tag Manager (Server) Container ID:", "enhanced-e-commerce-for-woocommerce-store"); ?>
      </h5>
      <input type="text" class="form-control-lg w-100" name="sst_server_container" id="sst_server_container" value="<?php echo esc_attr($sst_server_container); ?>">
      <p class="fw-bold">
        <a class="conv-link-blue" href="<?php echo esc_url_raw($doc_link_url); ?>" target="_blank">
          <?php esc_html_e('How To Create A Server Container?', "enhanced-e-commerce-for-woocommerce-store"); ?>
        </a>
      </p>
    </div>

    <!-- SST Server Config -->
    <div class="mt-4">
      <h5 class="fw-normal mb-1">
        <?php esc_html_e("Google Tag Manager (Server) Container Config:", "enhanced-e-commerce-for-woocommerce-store"); ?>
      </h5>
      <input type="text" class="form-control-lg w-100" name="sst_server_container_config" id="sst_server_container_config" value="<?php echo esc_attr($sst_server_container_config); ?>">
      <p class="fw-bold">
        <a class="conv-link-blue" href="<?php echo esc_url_raw($doc_link_url); ?>" target="_blank">
          <?php esc_html_e('How To Find The Container Config?', "enhanced-e-commerce-for-woocommerce-store"); ?>
        </a>
      </p>
    </div>

    <!-- SST Server Transport URL -->
    <div class="mt-4">
      <h5 class="fw-normal mb-1">
        <?php esc_html_e("Server URL:", "enhanced-e-commerce-for-woocommerce-store"); ?>
      </h5>
      <input type="text" class="form-control-lg w-100" name="sst_transport_url" id="sst_transport_url" value="<?php echo esc_attr($sst_transport_url); ?>">
      <p class="fw-bold">
        <a class="conv-link-blue" href="<?php echo esc_url_raw("https://" . TVC_AUTH_CONNECT_URL . "/help-center/configure_our_plugin_with_your_gtm.pdf"); ?>" target="_blank">
          <?php esc_html_e('How To Find GTM Server URL?', "enhanced-e-commerce-for-woocommerce-store"); ?>
        </a>
      </p>
    </div>

    <!-- SST Server Region -->
    <div class="mt-4 row">
      <div class="col-12">
        <h5 class="fw-normal mb-1">
          <?php esc_html_e("Region:", "enhanced-e-commerce-for-woocommerce-store"); ?>
        </h5>
        <select class="form-select form-select-lg mb-3 selecttwosearch w-100" name="sst_region" id="sst_region" style="width: 100%">
          <option><?php esc_html_e("Select region", "enhanced-e-commerce-for-woocommerce-store"); ?></option>
          <?php
          foreach ($gcp_regions as $gcp_region) {
            $selected = "";
            if ($sst_region == $gcp_region) {
              $selected = "selected";
            }
          ?>
            <option value="<?php echo esc_html_e($gcp_region); ?>" <?php echo $selected; ?>>
              <?php echo esc_html_e($gcp_region); ?>
            </option>
          <?php
          }
          ?>
        </select>
        <!-- <p class="fw-bold">
          <a class="conv-link-blue" href="<?php echo esc_url_raw("https://" . TVC_AUTH_CONNECT_URL . "/help-center/configure_our_plugin_with_your_gtm.pdf"); ?>" target="_blank">
            <?php esc_html_e('How To Setup a Server Container?', "enhanced-e-commerce-for-woocommerce-store"); ?>
          </a>
        </p> -->

      </div>
    </div>

    <input type="hidden" name="tracking_method" id="tracking_method" value="gtm">
  </form>
</div>


<script>
  jQuery(function() {
    jQuery(".selecttwosearch").select2({
      containerCssClass: 'w-100',
      width: 'resolve'
    });

    jQuery(document).on('change', 'form#gtmsstsettings_form', function() {
      jQuery('#use_your_gtm_id').removeClass("conv-border-danger");
      jQuery(".conv-btn-connect").removeClass("conv-btn-connect-disabled");
      jQuery(".conv-btn-connect").addClass("conv-btn-connect-enabled-sstgtm");
      jQuery(".conv-btn-connect").text('Save');
    });

    jQuery(document).on("click", ".conv-btn-connect-enabled-sstgtm", function() {
      conv_change_loadingbar("show");
      jQuery(this).addClass('disabled');

      var selected_vals = {};
      jQuery('form#gtmsstsettings_form input, form#gtmsstsettings_form select').each(function() {
        selected_vals[jQuery(this).attr("name")] = jQuery(this).val();
      });
      jQuery.ajax({
        type: "POST",
        dataType: "json",
        url: tvc_ajax_url,
        data: {
          action: "conv_save_pixel_data",
          pix_sav_nonce: "<?php echo wp_create_nonce('pix_sav_nonce_val'); ?>",
          conv_options_data: selected_vals,
          conv_options_type: ["eeoptions"],
        },
        beforeSend: function() {
          jQuery(".conv-btn-connect-enabled-google").text("Saving...");
        },
        success: function(response) {
          var user_modal_txt = "Your Server Side GTM Container - " + selected_vals['sst_web_container'];
          if (response == "0" || response == "1") {
            jQuery(".conv-btn-connect-enabled-google").text("Save");

            if (jQuery("#sst_web_container").val() == "") {
              jQuery("#conv_save_disconnect_txt").html('Server side tagging disconnected.');
              jQuery("#conv_save_disconnect_modal").modal("show");
            } else {
              jQuery("#conv_save_success_txt").html('Congratulations, you have successfully connected your <br> Google Tag Manager account with <br> ' + user_modal_txt);
              jQuery("#conv_save_success_modal").modal("show");
            }

          }
          conv_change_loadingbar("hide");
        }
      });

    });

  });
</script>